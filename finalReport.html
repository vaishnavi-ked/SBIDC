<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Rack Monitoring System</title>
    <!-- Custom fonts for this template-->
    <link rel="stylesheet" type="text/css" href="Public/css/jquery.seat-charts.css">
    <link href="Public/vendor/fontawesomeFree/css/all.min.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet" />
    <!-- Custom styles for this template-->
    <link href="Public/css/sb-admin-2.min.css" rel="stylesheet" />
    <link href="Public/css/custom.css" rel="stylesheet" type="text/css" />
    <link href="Public/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    
        <script src="Public/vendor/pdf/jspdf.umd.min.js"></script>
<script src="Public/vendor/pdf/jspdf.plugin.autotable.min.js"></script>
<script src="Public/vendor/xlsx/xlsx.full.min.js"></script>
<script src="Public/vendor/filesaver/FileSaver.min.js"></script>
<script src="Public/vendor/htmlcanvas/html2canvas.min.js"></script>

<!--<script src="Public/vendor/bootstrap/js/popper.min.js"></script>-->



<style>
    body {
      background-color: #121212;
      color: #f0f0f0;
    }

 .dropdown-menu {
  position: absolute;
  background-color: #333;
  border-radius: 5px;
  margin-top: 5px;
  padding: 10px;
  max-width: 90vw;
  word-wrap: break-word;
  overflow-x: auto;
  /* Add these new properties */
  right: 0;
  left: auto;
  max-height: 70vh;
  overflow-y: auto;
}
    .dropdown-item {
      color: #f0f0f0;
    }

    .dropdown-item:hover {
      background-color: #333;
      color: #fff;
    }

    .modal-calendar {
      display: none;
      position: absolute;
      background-color: #2b2b2b;
      color: #fff;
      padding: 20px;
      border-radius: 10px;
      z-index: 9999;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
      min-width: 250px;
    }

    input[type="date"] {
      background-color: #1e1e1e;
      color: #fff;
      border: 1px solid #444;
    }

    input[type="date"]:focus {
      border-color: #888;
      outline: none;
    }

    .btn-primary {
      background-color: #007bff;
      border: none;
    }

    .btn-secondary {
      background-color: #6c757d;
      border: none;
    }
    .dropdown-toggle::after {
  display: none !important;
}

  </style>



</head>
<body id="page-top" class="page-overview sidebar-toggled">
  <div id="widget" style="display:none;"></div>
  
   <div id="wrapper">
      <!-- Sidebar -->
       
      <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion toggled" id="accordionSidebar">
        <!-- Sidebar - Brand -->
        <div class="sidebar-brand d-flex align-items-center justify-content-center">
          <img src="public/img/SBI-Profile.png" alt="logo" />
        </div>
        <!-- Divider -->
        <hr class="sidebar-divider my-0" />
        <!-- Nav Item - Charts -->
        <!-- <li class="nav-item ">
               <a class="nav-link" href="overview.html">
                 <i class="fas fa-fw fa-chart-area"></i>
                 <span>Overview</span></a>
               </li> -->
        <!-- Nav Item - Dashboard -->
        <li class="nav-item active">
          <a class="nav-link" href="newform.html">
              <i class="fa-solid fa-rectangle-list"></i>
              <span>Form</span></a>
      </li>
      <li class="nav-item">
          <a class="nav-link" href="index.html">
              <i class="fas fa-fw fa-table"></i>
              <span>Rack Monitoring</span></a>
      </li>
      <li class="nav-item">
          <a class="nav-link" href="report.html">
              <i class="fa-solid fa-chart-line"></i>
              <span>Reports And Trends</span></a>
      </li>
        <!-- Divider -->
        <hr class="sidebar-divider d-none d-md-block" />
        <!-- Sidebar Toggler (Sidebar) -->
        <div class="text-center d-none d-md-inline">
          <button class="rounded-circle border-0" id="sidebarToggle"></button>
        </div>
      </ul>
      <!-- End of Sidebar -->
      <!-- Content Wrapper -->
      <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
          <!-- Topbar -->
          <nav
            class="navbar navbar-expand navbar-light topbar mb-4 static-top shadow"
          >
            <!-- Sidebar Toggle (Topbar) -->
            <button
              id="sidebarToggleTop"
              class="btn btn-link d-md-none rounded-circle mr-3"
            >
              <i class="fa fa-bars"></i>
            </button>
            <!-- Topbar Navbar -->
            <ul class="navbar-nav ml-auto">
              <li class="nav-item dropdown no-arrow mx-1">
                <!-- <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  id="alertsDropdown"
                  role="button"
                  data-toggle="dropdown"
                  aria-haspopup="true"
                  aria-expanded="false"
                >
                  <i class="fas fa-bell fa-fw"></i>
                  <span class="badge badge-danger badge-counter">3+</span>
                </a> -->
                <!-- Dropdown - Alerts -->
                <div
                  class="dropdown-list dropdown-menu dropdown-menu-right shadow animated--grow-in"
                  aria-labelledby="alertsDropdown"
                >
                  <!-- <h6 class="dropdown-header">Alerts Center</h6>
                  <a
                    class="dropdown-item d-flex align-items-center"
                    href="server.html"
                  > -->
                    <!-- <div class="mr-3">
                      <div class="icon-circle bg-primary">
                        <i class="fas fa-file-alt text-white"></i>
                      </div>
                    </div> -->
                    <div>
                      <div class="small text-gray-500">November 4, 2020</div>
                      <span class="font-weight-bold">Server issue</span>
                    </div>
                  </a>
                  <a
                    class="dropdown-item d-flex align-items-center"
                    href="cabin.html"
                  >
                    <div class="mr-3">
                      <div class="icon-circle bg-warning">
                        <i class="fas fa-exclamation-triangle text-white"></i>
                      </div>
                    </div>
                    <div>
                      <div class="small text-gray-500">November 4, 2020</div>
                      Rack Temperature is High
                    </div>
                  </a>
                  <a class="dropdown-item d-flex align-items-center" href="#">
                    <div class="mr-3">
                      <div class="icon-circle bg-warning">
                        <i class="fas fa-exclamation-triangle text-white"></i>
                      </div>
                    </div>
                    <div>
                      <div class="small text-gray-500">November 3, 2020</div>
                      Warning: Switchboard - Generator Group
                    </div>
                  </a>
                  <a
                    class="dropdown-item text-center small text-gray-500"
                    href="alarm-management.html"
                    >Show All Alerts</a
                  >
                </div>
              </li>
              <!-- <div class="topbar-divider d-none d-sm-block"></div> -->
              <!-- Nav Item - User Information -->
              <li class="nav-item">
                <a class="nav-link bell-container" href="#">
                  <i class="fa-solid fa-bell fa-2x"></i>
                  <span class="notification-badge">4</span>
                </a>
              </li>
              <li class="nav-item dropdown no-arrow">
                <a class="nav-link dropdown-toggle" href="#">
                  <img class="img-scnd-logo" src="public/img/kedlogo.png" />
                </a>
              </li>
              <button onclick="showDownloadHelp()" class="btn btn-info">Download Help</button>
              <!-- <div class="topbar-divider d-none d-sm-block"></div> -->
              <li class="nav-item dropdown no-arrow">
                <!-- <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  id="userDropdown"
                  role="button"
                  data-toggle="dropdown"
                  aria-haspopup="true"
                  aria-expanded="false"
                >
                  <span class="mr-2 d-none d-lg-inline text-gray-600 small"
                    >Supervisor</span
                  >
                  <img
                    class="img-profile rounded-circle"
                    src="https://source.unsplash.com/QAB-WJcbgJk/60x60"
                  />
                </a> -->
                <!-- Dropdown - User Information -->
                <div
                  class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                  aria-labelledby="userDropdown"
                >
                  <a class="dropdown-item" href="#">
                    <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                    Profile
                  </a>
                  <a class="dropdown-item" href="#">
                    <i class="fas fa-cogs fa-sm fa-fw mr-2 text-gray-400"></i>
                    Settings
                  </a>
                  <a class="dropdown-item" href="#">
                    <i class="fas fa-list fa-sm fa-fw mr-2 text-gray-400"></i>
                    Activity Log
                  </a>
                  <div class="dropdown-divider"></div>
                  <a
                    class="dropdown-item"
                    href="#"
                    data-toggle="modal"
                    data-target="#logoutModal"
                  >
                    <i
                      class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"
                    ></i>
                    Logout
                  </a>
                </div>
              </li>
            </ul>
          </nav>
          <!-- End of Topbar -->
          <!-- Begin Page Content -->
          <div class="container-fluid">
            <div
              class="d-sm-flex align-items-center justify-content-between mb-4"
            >
              <h1 class="m-0 font-weight-bold text-primary">
                Reports
              </h1>
              <!-- <h1 class="m-0 font-weight-bold text-primary">
                        Energy Dashboard <span id="locationName"></span>
                        </h1> -->
              <!-- <a
                        href="#"
                        class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"
                        ><i class="fas fa-download fa-sm text-white-50"></i> Generate
                        Report</a
                        > -->
            </div>
             <div class="row">
              <div class="col-xl-6 col-lg-6">
                <div class="card shadow mb-4">
                  <!-- Card Header - Dropdown -->
                  <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Power Consumption</h6>
                    <div class="dropdown">
                      <button class="btn btn-sm btn-light" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-ellipsis-v" id="ellipsisIcon"></i>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton" id="dropdownMenu">
                          <li><a class="dropdown-item select-dates-btn" href="#" id="selectDatesBtn" data-dropdown-id="dropdown1"><i class="fas fa-calendar-alt me-2"></i><span class="date-label">Select Dates</span></a></li>
                          <li><hr class="dropdown-divider" /></li>
                          <li><a class="dropdown-item export-btn" href="#" data-format="pdf"><i class="fas fa-file-pdf me-2"></i>Export as PDF</a></li>
                          <li><a class="dropdown-item export-btn" href="#" data-format="xlsx"><i class="fas fa-file-excel me-2"></i>Export as Excel</a></li>
                          <li><a class="dropdown-item export-btn" href="#" data-format="csv"><i class="fas fa-file-csv me-2"></i>Export as CSV</a></li>
                          <li><a class="dropdown-item export-btn" href="#" data-format="png"><i class="fas fa-file-image me-2"></i>Export as PNG</a></li>
                          <li><hr class="dropdown-divider" /></li>
                          <li><a class="dropdown-item print-btn" href="#"><i class="fas fa-print me-2"></i>Print</a></li>
                      </ul>
                    </div>
                  </div>
                  <!-- Card Body -->
                  <div class="card-body">
                    <div class="chart-area">
                      <div id="chartdiv"></div>
                    </div>
                  </div>
                </div>
              </div>


              <div class="col-xl-6 col-lg-6">
                <div class="card shadow mb-4">
                  <div
                    class="card-header py-3 d-flex flex-row align-items-center justify-content-between"
                  >
                    <h6 class="m-0 font-weight-bold text-primary">
                      DC HYDERABAD SNAPSHOT AS ON JAN 2025
                    </h6>
                    <div id="exportButton"><i class="fa-solid fa-ellipsis"></i></div>
                    <div id="exportOptions">
                        <button onclick="exportToCSV()">Export CSV</button>
                        <button onclick="exportToPDF()">Export PDF</button>
                    </div>
                  </div>
                  <div class="card-body">
                    
                    <div id="dataFAS">
                      <table id="floorProperty" class="build-details">
                          <thead>
                              <tr>
                                <th>Name</th>
                                <th>Server Hall 1</th>
                                <th>Server Hall 2</th>
                                <th>Server Hall 3</th>
                                <th>Server Hall 4</th>
                                <th>Total</th>
                                <th>Percentage</th>
                              </tr>
                          </thead>
                          <tbody id="floorPropertyBody">
                              <tr>
                                  <td></td>
                                  <td class="text-secondary"></td>
                                  <td class="text-success"></td>
                                  <td class="text-success"></td>
                                  <td class="text-success"></td>
                                  <td class="text-success"></td>
                                  <td class="text-success"></td>
                              </tr>
                          </tbody>
                      </table>
                  </div>
                  </div>
                </div>
              </div>
              <!-- Pie Chart -->
            </div>
            <div class="row">
              <!-- Area Chart -->
              <div class="col-xl-12 col-lg-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between position-relative">
                        <h6 class="m-0 font-weight-bold text-primary">
                            Rack Cooling Index
                        </h6>
                        <div id="exportChart"><i class="fa-solid fa-ellipsis"></i></div>
            
                        <!-- Export Options (Moved outside of heatmap container) -->
                        <div id="exportMenu1">
                            <button onclick="exportChart('image/png')">Export PNG</button>
                            <button onclick="exportCSV()">Export CSV</button>
                            <button onclick="exportPDF()">Export PDF</button>
                            <button onclick="printChart()">Print</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-area">
                            <div id="heatmap_consumption"></div>
                        </div>
                    </div>
                </div>
            </div>
            
              
            </div>
           </div>
          
        </div>
        <!-- End of Main Content -->
        <!-- Footer -->
        <footer class="sticky-footer bg-dark text-white">
          <div class="container my-auto">
            <div class="copyright text-center my-auto">
              <span>Designed And Developed By &copy Ked Technology</span>
            </div>
          </div>
        </footer>
      </div>
      <!-- End of Content Wrapper -->
    </div>
    <!-- End of Page Wrapper -->
    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
      <i class="fas fa-angle-up"></i>
    </a>
  <!-- Custom Calendar Modal -->
<div class="modal-calendar" id="calendarModal">
  <div class="modal-content-calendar">
    <h6>Select Date Range</h6>
    <div class="mt-3">
      <label>Start Date: <input type="date" id="startDate" class="form-control" /></label>
      <label class="mt-2">End Date: <input type="date" id="endDate" class="form-control" /></label>
    </div>
    <div class="date-selection-buttons mt-3 text-end">
      <button class="btn btn-secondary me-2" id="cancelDateSelection">Cancel</button>
      <button class="btn btn-primary" id="applyDateSelection">Apply</button>
    </div>
  </div>
</div>
<div id="widget" style="display:none;"></div>

     <script src="Public/vendor/amchart/core.js"></script>
      <script src="Public/vendor/amchart/charts.js"></script>
    <script src="Public/vendor/amchart/themes/animated.js"></script>
    <script src="Public/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <script type="text/javascript">
    var require = {
      paths: {
        //pointing nmodule at /module is a Niagara convention, allowing us to
        //refer to module resources without having RequireJS get hung up on
        //the use of absolute paths everywhere.
        "nmodule": "/module",
        "baja": "/module/bajaScript/rc/plugin/baja",
        "bajaScript": "/module/bajaScript/rc",
        "bajaux": "/module/bajaux/rc",
        "lex": "/module/js/rc/lex/lexplugin",
        "log": "/module/js/rc/log/logPlugin",
        "css": "/module/js/com/tridium/js/ext/require/css",

        "jquery": "/module/js/rc/jquery/jquery",
        "Handlebars": "/module/js/rc/handlebars/handlebars",
        "Promise": "/module/js/rc/bluebird/bluebird",

        // these are runtime dependencies for require-handlebars-plugin
        "hbs": "/module/js/rc/require-handlebars-plugin/hbs",
        "i18nprecompile": "/module/js/rc/require-handlebars-plugin/hbs/i18nprecompile",
        "json2": "/module/js/rc/require-handlebars-plugin/hbs/json2",
        "underscore": "/module/js/rc/underscore/underscore"
        
      },

      hbs: {
        disableI18n: true
      }
    }
  </script>
     <script type="text/javascript"
          data-main="/module/sbidcnew/rc/sbidcnew.run.js"
          src="http://localhost/module/js/com/tridium/js/ext/require/require.min.js"></script>


<script>
// Date picker functionality (outside Baja.js)
// Global variables for dates
// let startDate = '';
// let endDate = '';
// let fetchDataFunction = null;
// let currentDropdown = null;

// // Date picker functionality (outside Baja.js)
// document.addEventListener('DOMContentLoaded', function() {
//   const calendarModal = document.getElementById("calendarModal");
//   let datesSelected = false;
  
//   // Initialize dropdowns
//   const dropdownElements = document.querySelectorAll('.dropdown');
//   const dropdownInstances = [];
  
//   dropdownElements.forEach(dropdownElement => {
//     const dropdownInstance = new bootstrap.Dropdown(dropdownElement);
//     dropdownInstances.push({
//       element: dropdownElement,
//       instance: dropdownInstance
//     });
    
//     // Store dropdown ID on the toggle button
//     const toggleButton = dropdownElement.querySelector('.dropdown-toggle');
//     if (toggleButton) {
//       toggleButton.dataset.dropdownId = dropdownElement.id;
//     }
//   });
  
//   // Handle dropdown toggle clicks
//   document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
//     toggle.addEventListener('click', function(e) {
//       currentDropdown = this.closest('.dropdown');
      
//       // If clicking the same dropdown, let Bootstrap handle the toggle
//       if (currentDropdown.classList.contains('show')) {
//         return;
//       }
      
//       // Close other dropdowns
//       dropdownInstances.forEach(instance => {
//         if (instance.element !== currentDropdown) {
//           instance.instance.hide();
//         }
//       });
//     });
//   });
  
//   // Date selection button handler
//   document.getElementById('selectDatesBtn')?.addEventListener('click', function(e) {
//     e.preventDefault();
//     e.stopPropagation();
    
//     // Store current dropdown
//     currentDropdown = this.closest('.dropdown');
    
//     // Close the dropdown menu
//     const dropdownInstance = bootstrap.Dropdown.getInstance(currentDropdown);
//     if (dropdownInstance) {
//       dropdownInstance.hide();
//     }
    
//     // Show the calendar modal
//     const rect = this.getBoundingClientRect();
//     calendarModal.style.display = "block";
//     calendarModal.style.top = `${rect.bottom + window.scrollY}px`;
//     calendarModal.style.left = `${rect.left}px`;
//   });
  
//   // Cancel button
//   document.getElementById("cancelDateSelection")?.addEventListener("click", function(e) {
//     e.stopPropagation();
//     calendarModal.style.display = "none";
//   });

//   // Apply button - now calls the global fetchDataFunction
//   document.getElementById("applyDateSelection")?.addEventListener("click", function(e) {
//     e.stopPropagation();
//     startDate = document.getElementById("startDate").value;
//     endDate = document.getElementById("endDate").value;
    
//     if (startDate && endDate) {
//       datesSelected = true;
//       if (currentDropdown) {
//         const dateLabel = currentDropdown.querySelector('.date-label');
//         if (dateLabel) {
//           dateLabel.textContent = `${startDate} to ${endDate}`;
//         }
//       }
//       calendarModal.style.display = "none";
      
//       // Call the fetch function if it's available
//       if (fetchDataFunction) {
//         fetchDataFunction(startDate, endDate);
//       }
      
//       // Re-open the dropdown menu for export options
//       if (currentDropdown) {
//         const dropdownInstance = bootstrap.Dropdown.getInstance(currentDropdown);
//         if (dropdownInstance) {
//           dropdownInstance.show();
//         }
//       }
//     } else {
//       alert("Please select both start and end dates.");
//     }
//   });

//   // Click outside handler
//   document.addEventListener('click', function(e) {
//     if (!e.target.closest('.modal-calendar') && !e.target.closest('.select-dates-btn')) {
//       calendarModal.style.display = "none";
      
//       if (!datesSelected && currentDropdown) {
//         const dropdownInstance = bootstrap.Dropdown.getInstance(currentDropdown);
//         if (dropdownInstance) {
//           dropdownInstance.hide();
//         }
//         resetDateSelection();
//       }
//     }
//   });

//   // Reset button
//   document.getElementById("resetDates")?.addEventListener("click", function(e) {
//     e.stopPropagation();
//     resetDateSelection();
//     if (currentDropdown) {
//       const dateLabel = currentDropdown.querySelector('.date-label');
//       if (dateLabel) {
//         dateLabel.textContent = 'Select Dates';
//       }
//     }
//   });

//   function resetDateSelection() {
//     document.getElementById("startDate").value = '';
//     document.getElementById("endDate").value = '';
//     startDate = '';
//     endDate = '';
    
//     if (currentDropdown) {
//       const dateLabel = currentDropdown.querySelector('.date-label');
//       if (dateLabel) {
//         dateLabel.textContent = 'Select Dates';
//       }
//     }
    
//     datesSelected = false;
//   }
  
//   // Export button handlers
//   document.querySelectorAll('.export-btn').forEach(btn => {
//     btn.addEventListener('click', function(e) {
//       e.preventDefault();
//       const format = this.dataset.format;
      
//       // Close the dropdown after selection
//       if (currentDropdown) {
//         const dropdownInstance = bootstrap.Dropdown.getInstance(currentDropdown);
//         if (dropdownInstance) {
//           dropdownInstance.hide();
//         }
//       }
      
//       downloadReport(format);
//     });
//   });
// });
// Global variables for dates and dropdown management
// Add this function to your code
window.showDownloadHelp = function() {
    // Create a modal container
    const modal = document.createElement('div');
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
    modal.style.zIndex = '1000';
    modal.style.display = 'flex';
    modal.style.justifyContent = 'center';
    modal.style.alignItems = 'center';
    
    // Create content container
    const content = document.createElement('div');
    content.style.backgroundColor = 'black';
    content.style.padding = '20px';
    content.style.borderRadius = '8px';
    content.style.maxWidth = '600px';
    content.style.maxHeight = '80vh';
    content.style.overflowY = 'auto';
    
    // Add close button
    const closeButton = document.createElement('button');
    closeButton.textContent = '×';
    closeButton.style.position = 'absolute';
    closeButton.style.top = '10px';
    closeButton.style.right = '10px';
    closeButton.style.background = 'none';
    closeButton.style.border = 'none';
    closeButton.style.fontSize = '24px';
    closeButton.style.cursor = 'pointer';
    closeButton.onclick = function() {
        document.body.removeChild(modal);
    };
    
    // Add title
    const title = document.createElement('h2');
    title.textContent = 'How to Download Reports';
    title.style.marginTop = '0';
    title.style.color = '#2c3e50';
    
    // Add content
    const helpContent = document.createElement('div');
    helpContent.innerHTML = `
        <h3>Download Options</h3>
        <p>You can download power consumption reports in three formats:</p>
        
        <h4>1. PDF Format</h4>
        <p><strong>Best for:</strong> Printable reports, formal documentation</p>
        <p><strong>Steps:</strong></p>
        <ol>
            <li>Select your date range (optional)</li>
            <li>Click the "Download" button</li>
            <li>Choose "PDF" from the format options</li>
            <li>The report will download automatically</li>
        </ol>
        
        <h4>2. Excel Format (XLSX)</h4>
        <p><strong>Best for:</strong> Data analysis, further calculations</p>
        <p><strong>Steps:</strong></p>
        <ol>
            <li>Select your date range (optional)</li>
            <li>Click the "Download" button</li>
            <li>Choose "Excel" from the format options</li>
            <li>The spreadsheet will download automatically</li>
            <li>Open with Microsoft Excel or similar software</li>
        </ol>
        
        <h4>3. CSV Format</h4>
        <p><strong>Best for:</strong> Importing into other systems, simple data processing</p>
        <p><strong>Steps:</strong></p>
        <ol>
            <li>Select your date range (optional)</li>
            <li>Click the "Download" button</li>
            <li>Choose "CSV" from the format options</li>
            <li>The CSV file will download automatically</li>
            <li>Can be opened with Excel, text editors, or database systems</li>
        </ol>
        
        <h3>Notes:</h3>
        <ul>
            <li>If no date range is selected, the report will show the last 12 months of data</li>
            <li>PDF reports include the company logo and generation timestamp</li>
            <li>Excel/CSV files contain raw data for further processing</li>
            <li>Large date ranges may take longer to process</li>
        </ul>
    `;
    
    // Assemble the modal
    content.appendChild(closeButton);
    content.appendChild(title);
    content.appendChild(helpContent);
    modal.appendChild(content);
    
    // Add to document
    document.body.appendChild(modal);
    
    // Close when clicking outside content
    modal.onclick = function(e) {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    };
};

// Add this to your UI (e.g., next to the download button)
// <button onclick="showDownloadHelp()" class="btn btn-info">Download Help</button>

let startDate = '';
let endDate = '';
let fetchDataFunction = null;
const dropdownInstances = new Map();

function initializeDropdowns() {
  document.querySelectorAll('.dropdown').forEach(dropdownElement => {
    const dropdownId = dropdownElement.id || `dropdown-${Math.random().toString(36).substr(2, 9)}`;
    dropdownElement.id = dropdownId;

    // Always remove previous event handlers
    if (dropdownInstances.has(dropdownId)) {
      const prevHandlers = dropdownInstances.get(dropdownId).handlers;
      const toggleButton = dropdownElement.querySelector('.dropdown-toggle');
      if (toggleButton && prevHandlers.toggleClick) {
        toggleButton.removeEventListener('click', prevHandlers.toggleClick);
      }

      const selectDatesBtn = dropdownElement.querySelector('.select-dates-btn');
      if (selectDatesBtn && prevHandlers.selectDatesBtn) {
        selectDatesBtn.removeEventListener('click', prevHandlers.selectDatesBtn);
      }

      dropdownElement.querySelectorAll('.export-btn').forEach(btn => {
        const format = btn.dataset.format;
        if (prevHandlers[`export-${format}`]) {
          btn.removeEventListener('click', prevHandlers[`export-${format}`]);
        }
      });

      dropdownInstances.delete(dropdownId);
    }

    const dropdownInstance = new bootstrap.Dropdown(dropdownElement);
    const handlers = {};

    const toggleButton = dropdownElement.querySelector('.dropdown-toggle');
    if (toggleButton) {
      toggleButton.dataset.dropdownId = dropdownId;

      const toggleHandler = function () {
        // Reset date inputs and global variables
        document.getElementById("startDate").value = '';
        document.getElementById("endDate").value = '';
        startDate = '';
        endDate = '';

        const dateLabel = dropdownElement.querySelector('.date-label');
        if (dateLabel) {
          dateLabel.textContent = 'Select Dates';
        }

        // Hide calendar modal if open
        document.getElementById("calendarModal").style.display = "none";
      };

      toggleButton.addEventListener('click', toggleHandler);
      handlers.toggleClick = toggleHandler;
    }

    // Setup date selection button
    const selectDatesBtn = dropdownElement.querySelector('.select-dates-btn');
    if (selectDatesBtn) {
      const dateHandler = function (e) {
        e.preventDefault();
        e.stopPropagation();

        dropdownInstance.hide(); // close dropdown
        const calendarModal = document.getElementById("calendarModal");
        const rect = selectDatesBtn.getBoundingClientRect();

        calendarModal.style.display = "block";
        calendarModal.style.top = `${rect.bottom + 200}px`;
        calendarModal.style.left = `${rect.left + 380}px`;

        calendarModal.dataset.activeDropdown = dropdownId;

        document.getElementById("startDate").value = '';
        document.getElementById("endDate").value = '';
      };

      selectDatesBtn.addEventListener('click', dateHandler);
      handlers.selectDatesBtn = dateHandler;
    }

    // Setup export buttons
    // Setup export buttons
dropdownElement.querySelectorAll('.export-btn').forEach(btn => {
  const format = btn.dataset.format;
  const exportHandler = function (e) {
    e.preventDefault();
    dropdownInstance.hide();
    downloadReport(format);

    // ✅ Reset start/end dates
    document.getElementById("startDate").value = '';
    document.getElementById("endDate").value = '';
    startDate = '';
    endDate = '';

    // ✅ Reset date label text
    const dateLabel = dropdownElement.querySelector('.date-label');
    if (dateLabel) {
      dateLabel.textContent = 'Select Dates';
    }

    // ✅ Clear active dropdown tracking
    document.getElementById("calendarModal").dataset.activeDropdown = '';
  };

  btn.addEventListener('click', exportHandler);
  handlers[`export-${format}`] = exportHandler;
});


    dropdownInstances.set(dropdownId, {
      element: dropdownElement,
      instance: dropdownInstance,
      handlers: handlers
    });
  });
}

// Calendar modal handlers
document.addEventListener('DOMContentLoaded', function () {
  initializeDropdowns();

  const calendarModal = document.getElementById("calendarModal");

  document.getElementById("applyDateSelection")?.addEventListener("click", function (e) {
    e.stopPropagation();
    startDate = document.getElementById("startDate").value;
    endDate = document.getElementById("endDate").value;

    if (startDate && endDate) {
      const dropdownId = calendarModal.dataset.activeDropdown;
      const dropdownData = dropdownInstances.get(dropdownId);

      if (dropdownData) {
        const dateLabel = dropdownData.element.querySelector('.date-label');
        if (dateLabel) {
          dateLabel.textContent = `${startDate} to ${endDate}`;
        }

        calendarModal.style.display = "none";

        if (fetchDataFunction) {
          fetchDataFunction(startDate, endDate);
        }

        dropdownData.instance.show(); // re-open dropdown
      }
    } else {
      alert("Please select both start and end dates.");
    }
  });

  document.getElementById("cancelDateSelection")?.addEventListener("click", function (e) {
    e.stopPropagation();
    calendarModal.style.display = "none";
  });

document.getElementById("resetDates")?.addEventListener("click", function (e) {
  e.stopPropagation();

  // Clear date input fields and global variables
  document.getElementById("startDate").value = '';
  document.getElementById("endDate").value = '';
  startDate = '';
  endDate = '';

  // Hide calendar modal
  const calendarModal = document.getElementById("calendarModal");
  calendarModal.style.display = 'none';

  // Reset label and close active dropdown
  const dropdownId = calendarModal.dataset.activeDropdown;
  const dropdownData = dropdownInstances.get(dropdownId);
  if (dropdownData) {
    const dateLabel = dropdownData.element.querySelector('.date-label');
    if (dateLabel) {
      dateLabel.textContent = 'Select Dates';
    }

    // Hide dropdown if visible
    dropdownData.instance.hide();
  }
});


  // Handle clicking outside dropdown/modal
  document.addEventListener('click', function (e) {
  const calendarModal = document.getElementById("calendarModal");
  const isCalendar = e.target.closest('#calendarModal');
  const isDropdown = e.target.closest('.dropdown');
  const isButton = e.target.closest('.select-dates-btn');

  if (!isCalendar && !isDropdown && !isButton) {
    // Hide modal
    calendarModal.style.display = 'none';

    // Reset dates
    document.getElementById("startDate").value = '';
    document.getElementById("endDate").value = '';
    startDate = '';
    endDate = '';

    const dropdownId = calendarModal.dataset.activeDropdown;
    const dropdownData = dropdownInstances.get(dropdownId);
    if (dropdownData) {
      const dateLabel = dropdownData.element.querySelector('.date-label');
      if (dateLabel) {
        dateLabel.textContent = 'Select Dates';
      }

      // Hide dropdown
      dropdownData.instance.hide();
    }
  }
});

});

// Handle dynamic dropdowns
document.addEventListener('DOMNodeInserted', function (e) {
  if (e.target.classList && e.target.classList.contains('dropdown')) {
    initializeDropdowns();
  } else if (e.target.querySelectorAll) {
    const dropdowns = e.target.querySelectorAll('.dropdown');
    if (dropdowns.length > 0) {
      initializeDropdowns();
    }
  }
});

require(['baja!'], function (baja) {
  // Chart variables
  let chart;
  let series = {}; // Object to hold all series
  let isDailyView = false;
  const serverHalls = ['SVR01', 'SVR02', 'SVR03', 'SVR04'];
  const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A']; // Different colors for each series

 am4core.useTheme(am4themes_animated);
    window.charts = {}; 
    // Initialize a single chart
function initChart(divId) {
    // Create chart instance
    let chart = am4core.create(divId, am4charts.XYChart);
    chart.paddingRight = 20;
    
    // Create date axis (X-axis)
    let dateAxis = chart.xAxes.push(new am4charts.DateAxis());
    dateAxis.renderer.minGridDistance = 60;
    dateAxis.renderer.labels.template.fill = am4core.color("#ffffff");
    
    // Format X-axis to show month names
    dateAxis.dateFormats.setKey("day", "MMM");
    dateAxis.periodChangeDateFormats.setKey("day", "MMM");
    
    // Create value axis (Y-axis)
    let valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
    valueAxis.title.text = "Power Consumption (kW)";
    valueAxis.title.fill = am4core.color("#ffffff");
    valueAxis.renderer.labels.template.fill = am4core.color("#ffffff");
    
    // Create series for each server hall
    serverHalls.forEach((hall, index) => {
        let series = chart.series.push(new am4charts.LineSeries());
        series.dataFields.dateX = "date";
        series.dataFields.valueY = hall;
        series.name = hall;
        series.tooltipText = "{name}: {valueY} kW";
        series.stroke = am4core.color(colors[index]);
        series.strokeWidth = 2;
        
        // Add bullets
        let bullet = series.bullets.push(new am4charts.CircleBullet());
        bullet.circle.stroke = am4core.color("#fff");
        bullet.circle.strokeWidth = 2;
        bullet.circle.radius = 4;
    });
    
    // Add cursor
    chart.cursor = new am4charts.XYCursor();
    chart.cursor.xAxis = dateAxis;
    chart.cursor.lineX.stroke = am4core.color("#ffffff");
    chart.cursor.lineY.stroke = am4core.color("#ffffff");
    
    // Add legend
    chart.legend = new am4charts.Legend();
    chart.legend.labels.template.fill = am4core.color("#ffffff"); 
    chart.logo.disabled = true;
    
    return chart;
}

    // Initialize all charts
    function initCharts() {
        // Initialize main chart
        window.charts['chartdiv'] = initChart('chartdiv');
        
        // Initialize additional charts if needed
        if (document.getElementById('chartdiv3')) {
            window.charts['chartdiv3'] = initChart('chartdiv3');
        }
        // Add more charts as needed...
    }

    // Fetch data function
    window.fetchData = function(start, end, isDefault = false) {
        console.log("Fetching data from", start, "to", end);
        
        window.rawData = {};
        window.dailyData = {};
        serverHalls.forEach(hall => {
            window.rawData[hall] = [];
            window.dailyData[hall] = [];
        });
        
        isDailyView = start === end;
        
        const promises = serverHalls.map(hall => {
            const query = `local:|fox:|history:/sbidcnew/${hall}?period=timeRange;start=${start}T23:58:00.000+05:30;end=${end}T23:59:00.000+05:30|bql:select timestamp as 'timestamp',value as 'value'`;
            
            return baja.Ord.make(query).get({
                cursor: {
                    each: function(row) { 
                        const timestamp = new Date(row.get('timestamp'));
                        const value = parseFloat(row.get('value'));
                        
                        window.rawData[hall].push({
                            datetime: timestamp,
                            value: value
                        });
                        
                        if (isDailyView) {
                            window.dailyData[hall].push({
                                date: timestamp,
                                value: value
                            });
                        }
                    }
                }
            });
        });
        
        Promise.all(promises)
            .then(() => {
                if (!isDailyView) {
                    serverHalls.forEach(hall => {
                        const groupedByDate = {};
                        
                        window.rawData[hall].forEach(item => {
                            const dateKey = item.datetime.toISOString().split('T')[0];
                            groupedByDate[dateKey] = {
                                date: new Date(dateKey),
                                value: item.value
                            };
                        });
                        
                        window.dailyData[hall] = Object.values(groupedByDate).sort((a, b) => a.date - b.date);
                    });
                }
                
                // Prepare combined data
                const combinedData = [];
                const allDates = new Set();
                
                serverHalls.forEach(hall => {
                    window.dailyData[hall].forEach(item => {
                        allDates.add(item.date.getTime());
                    });
                });
                
                Array.from(allDates).sort().forEach(timestamp => {
                    const dataPoint = { date: new Date(timestamp) };
                    serverHalls.forEach(hall => {
                        const hallData = window.dailyData[hall].find(item => 
                            item.date.getTime() === timestamp
                        );
                        dataPoint[hall] = hallData ? hallData.value : null;
                    });
                    combinedData.push(dataPoint);
                });
                
                // Update all charts
                Object.keys(window.charts).forEach(divId => {
                    if (window.charts[divId]) {
                        window.charts[divId].data = combinedData;
                    }
                });
            })
            .catch((err) => {
                console.error("Query failed:", err);
                alert("Error fetching data: " + err.message);
            });
    };

    // Initialize the application
    function init() {
        initCharts();
        
        // Load default data
        const end = new Date();
        const start = new Date();
        console.log(start + end );
        start.setMonth(start.getMonth() - 11);
        end.setMonth(end.getMonth()-0);
        start.setDate(30);
        end.setDate(30)
        
        window.fetchData(
            formatDate(start), 
            formatDate(end), 
            true
        );
    }

window.downloadReport = function(format = "pdf") {
    const now = new Date();
    const nowStr = now.toISOString().split("T")[0];
    const baseName = "Power_Consumption";
    const logoURL = 'Public/img/kedlogo.png';

    // Check if dates are selected
    const hasDateSelection = startDate && endDate;
    
    let fileName = hasDateSelection
        ? `${baseName}_${nowStr}_(${startDate}_to_${endDate}).${format}`
        : `${baseName}_${nowStr}.${format}`;

    // Function to fetch and process data for download
    function fetchAndDownload() {
        window.rawData = {};
        serverHalls.forEach(hall => {
            window.rawData[hall] = [];
        });

        const promises = serverHalls.map(hall => {
            const query = `local:|fox:|history:/sbidcnew/${hall}?period=timeRange;start=${startDate}T00:00:00.000+05:30;end=${endDate}T23:59:00.000+05:30|bql:select timestamp as 'timestamp',value as 'value'`;
            console.log("query" + query);
            return baja.Ord.make(query).get({
                cursor: {
                    each: function(row) { 
                        const timestamp = new Date(row.get('timestamp'));
                        const value = parseFloat(row.get('value'));
                        
                        window.rawData[hall].push({
                            datetime: timestamp,
                            value: value
                        });
                    }
                }
            });
        });

        Promise.all(promises)
            .then(() => {
                // Combine all data by timestamp
                const combinedData = {};
                
                serverHalls.forEach(hall => {
                    window.rawData[hall].forEach(item => {
                        const timestamp = item.datetime.getTime();
                        if (!combinedData[timestamp]) {
                            combinedData[timestamp] = {
                                datetime: item.datetime,
                                values: {}
                            };
                        }
                        combinedData[timestamp].values[hall] = item.value;
                    });
                });
                
                // Convert to array and sort by datetime
                const sortedData = Object.values(combinedData).sort((a, b) => a.datetime - b.datetime);
                
                // Prepare rows for export
                const rows = sortedData.map((item, index) => {
                    const row = {
                        Index: index + 1,
                        "Date & Time": item.datetime.toLocaleString('en-US', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        }).replace(/(\d+)\/(\d+)\/(\d+),?/, '$3-$1-$2')
                    };
                    
                    serverHalls.forEach((hall, i) => {
                        row[`S${i+1} (kW)`] = (item.values[hall] || 0).toFixed(3);
                    });
                    
                    return row;
                });

                generateFile(rows);
            })
            .catch((err) => {
                console.error("Error fetching data for download:", err);
                alert("Error fetching data for download: " + err.message);
            });
    }

    // Function to generate the actual file
    function generateFile(rows) {
        if (format === "pdf") {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const logo = new Image();
                
                logo.onload = function() {
                    // Add logo (top-left)
                    doc.addImage(logo, 'PNG', 10, 10, 30, 10);
                    generatePdfContent(doc);
                };
                
                logo.onerror = function() {
                    generatePdfContent(doc);
                };
                logo.src = logoURL;
                
                function generatePdfContent(doc) {
                    // Report title (centered)
                    doc.setFontSize(16);
                    const titleY = logo.complete ? 30 : 20;
                    doc.text(`Power Consumption Report`, 100, titleY, { align: "center" });
                    
                    // Generation timestamp (right-aligned)
                    doc.setFontSize(10);
                    doc.text(`Generated: ${now.toLocaleString()}`, 200, 10, { align: "right" });
                    
                    doc.setFontSize(12);
                    doc.text(`Date Range: ${startDate} to ${endDate}`, 14, titleY + 10);
                    // Date range (if selected)
                    // if (hasDateSelection) {
                    //     doc.setFontSize(12);
                    //     doc.text(`Date Range: ${startDate} to ${endDate}`, 14, titleY + 10);
                    // }

                    // Create the table
                    const headers = ["Index", hasDateSelection ? "Date & Time" : "Month", ...serverHalls.map((_, i) => `S${i+1} (kW)`)];
                    const body = rows.map(row => [
                        row.Index,
                        row[hasDateSelection ? "Date & Time" : "Month"],
                        ...serverHalls.map((_, i) => row[`S${i+1} (kW)`])
                    ]);

                    doc.autoTable({
                        startY: titleY + (hasDateSelection ? 20 : 10),
                        head: [headers],
                        body: body,
                        styles: {
                            overflow: 'linebreak',
                            cellPadding: 3,
                            fontSize: 10,
                            halign: 'center',
                            valign: 'middle'
                        },
                        // Enable pagination for large datasets
                        margin: { top: titleY + (hasDateSelection ? 20 : 10) },
                        bodyStyles: { valign: 'top' },
                        alternateRowStyles: { fillColor: [240, 240, 240] },
                        columnStyles: {
                            0: { cellWidth: 'auto' },
                            1: { cellWidth: hasDateSelection ? 40 : 30 }
                        }
                    });

                    doc.save(fileName);
                }
            } catch (error) {
                console.error("PDF generation error:", error);
                alert("Failed to generate PDF. Please try another format.");
            }
        } else {
            try {
                // For Excel/CSV
                const worksheet = XLSX.utils.json_to_sheet(rows);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Power Data");
                
                const wbout = XLSX.write(workbook, {
                    bookType: format === "csv" ? "csv" : "xlsx",
                    type: "array"
                });
                
                saveAs(new Blob([wbout], { type: "application/octet-stream" }), fileName);
            } catch (error) {
                console.error("Excel/CSV generation error:", error);
                alert("Failed to generate Excel/CSV file.");
            }
        }
    }

    // Check if we need to fetch fresh data or use existing
    if (hasDateSelection) {
        // For date selection, fetch fresh data
        fetchAndDownload();
    } else {
        // For default view, use existing monthly data
        const hasData = serverHalls.every(hall => 
            window.dailyData[hall] && window.dailyData[hall].length > 0
        );
        
        if (!hasData) {
            alert("No data available for all server halls. Please fetch data first.");
            return;
        }

        // Get last 12 months of data (30th of each month)
        const monthlyData = {};
        const monthsToShow = 12;
        
        // Find the most recent month end date (30th)
        let currentDate = new Date();
        if (currentDate.getDate() < 30) {
            currentDate.setMonth(currentDate.getMonth() - 1);
        }
        currentDate.setDate(30);
        currentDate.setHours(0, 0, 0, 0);
        
        // Prepare 12 months data points
        for (let i = 0; i < monthsToShow; i++) {
            const monthDate = new Date(currentDate);
            monthDate.setMonth(currentDate.getMonth() - i);
            
            // Ensure we use the 30th (or last day for shorter months)
            const lastDay = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();
            monthDate.setDate(Math.min(30, lastDay));
            
            const timestamp = monthDate.getTime();
            monthlyData[timestamp] = {
                date: monthDate,
                values: {}
            };
            
            serverHalls.forEach(hall => {
                // Find the closest data point to this month end
                const hallData = window.dailyData[hall];
                let closestData = null;
                let minDiff = Infinity;
                
                for (const item of hallData) {
                    const diff = Math.abs(item.date.getTime() - timestamp);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestData = item;
                    }
                }
                
                if (closestData) {
                    monthlyData[timestamp].values[hall] = closestData.value;
                } else {
                    monthlyData[timestamp].values[hall] = 0;
                }
            });
        }
        
        // Convert to array and sort by date (oldest first)
        const sortedData = Object.values(monthlyData).sort((a, b) => a.date - b.date);
        
        // Prepare rows for export
        const rows = sortedData.map((item, index) => {
            const row = {
                Index: index + 1,
                "Month": item.date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: '2-digit'
                }).replace(',', '')
            };
            
            serverHalls.forEach((hall, i) => {
                row[`S${i+1} (kW)`] = (item.values[hall] || 0).toFixed(3);
            });
            
            return row;
        });

        generateFile(rows);
    }
};
  
  // Format date as YYYY-MM-DD
  function formatDate(date) {
    const d = new Date(date);
    return d.toISOString().split('T')[0];
  }
  init();
});
// Baja.js code
// require(['baja!'], function (baja) {
//   // Chart variables
//   let chart;
//   let series;
//   let isDailyView = false;
  
//   // Initialize chart
// function initChart() {
//     const root = am5.Root.new("chartdiv");
//     root.setThemes([am5themes_Animated.new(root)]);
    
//     const chart = root.container.children.push(
//       am5xy.XYChart.new(root, {
//         panX: true,
//         panY: true,
//         wheelX: "panX",
//         wheelY: "zoomX",
//         pinchZoomX: true
//       })
//     );
//     const cursor = chart.set("cursor", am5xy.XYCursor.new(root, {}));
//     cursor.lineY.set("visible", false);
    
//     const xAxis = chart.xAxes.push(
//       am5xy.DateAxis.new(root, {
//         maxDeviation: 0.3,
//         baseInterval: {
//           timeUnit: "day",
//           count: 1
//         },
//         renderer: am5xy.AxisRendererX.new(root, {}),
//         tooltip: am5.Tooltip.new(root, {})
//       })
//     );
    
//     const yAxis = chart.yAxes.push(
//       am5xy.ValueAxis.new(root, {
//         renderer: am5xy.AxisRendererY.new(root, {})
//       })
//     );
    
//     series = chart.series.push(
//       am5xy.LineSeries.new(root, {
//         name: "Series",
//         xAxis: xAxis,
//         yAxis: yAxis,
//         valueYField: "value",
//         valueXField: "date",
//         tooltip: am5.Tooltip.new(root, {
//           labelText: "{valueY}"
//         })
//       })
//     );
    
//     series.strokes.template.setAll({
//       strokeWidth: 2
//     });
    
//     series.bullets.push(function() {
//       return am5.Bullet.new(root, {
//         sprite: am5.Circle.new(root, {
//           radius: 4,
//           fill: series.get("fill")
//         })
//       });
//     });
    
//     chart.set("scrollbarX", am5.Scrollbar.new(root, {
//       orientation: "horizontal"
//     }));
    
//     return chart;
//   }
  
//   // Query for selected date range
//   function getDateRangeQuery(start, end) {
//     return `local:|fox:|history:/sbi/SVR01?period=timeRange;start=${start}T00:00:00.000+05:30;end=${end}T23:59:00.000+05:30|bql:select timestamp as 'timestamp',value as 'value'`;
//   }
  
//   // Default query for last 12 months
//   function getDefaultQuery() {
//     const end = new Date();
//     const start = new Date();
//     start.setMonth(start.getMonth() - 11);
//     start.setDate(30);
//     return getDateRangeQuery(formatDate(start), formatDate(end));
//   }
  
//   // Fetch data - now available globally via fetchDataFunction
//   function fetchData(start, end, isDefault = false) {
//     console.log("Fetching data from", start, "to", end);
    
//     window.rawData = [];
//     window.dailyData = [];
//     window.fullDailyData = [];
    
//     isDailyView = start === end;
    
//     const query = isDefault ? getDefaultQuery() : getDateRangeQuery(start, end);
    
//     baja.Ord.make(query)
//       .get({
//         cursor: {
//           each: function(row) { 
//             const timestamp = new Date(row.get('timestamp'));
//             const value = parseFloat(row.get('value'));
            
//             window.rawData.push({
//               datetime: timestamp,
//               value: value
//             });
//             console.log("Grouped data by date:", JSON.stringify(rawData, null, 2));
//             if (isDailyView) {
//               window.dailyData.push({
//                 date: timestamp.getTime(),
//                 value: value
//               });
//             }
//           }
//         }
//       })
//       .then(() => {
//         if (!isDailyView) {
//           // Process into daily values
//           const groupedByDate = {};
          
//           window.rawData.forEach(item => {
//             const dateKey = new Date(item.datetime).toISOString().split('T')[0];
//             groupedByDate[dateKey] = {
//               date: dateKey,
//               value: item.value,
//               rawDatetime: item.datetime
//             };
//           });
          
//           window.dailyData = Object.values(groupedByDate)
//             .sort((a, b) => new Date(a.date) - new Date(b.date))
//             .map(item => ({
//               date: new Date(item.date).getTime(),
//               value: item.value
//             }));
//         }
        
//         if (series) {
//           series.data.setAll(window.dailyData);
//         }
//       })
//       .catch((err) => {
//         console.error("Query failed:", err);
//         alert("Error fetching data: " + err.message);
//       });
//   }

//   // Download report function
//   window.downloadReport = function(format = "pdf") {
//     const now = new Date();
//     const nowStr = now.toISOString().split("T")[0];
//     const baseName = "Power_Consumption";
//     const slotPath = window.slotPath || "Point path not available";

//     if (!window.rawData || window.rawData.length === 0) {
//         alert("No data available to download. Please fetch data first.");
//         return;
//     }

//     let fileName = startDate && endDate
//         ? `${baseName}_${nowStr}_(${startDate}_to_${endDate}).${format}`
//         : `${baseName}_${nowStr}.${format}`;
        
//         console.log("filename " + fileName);

//     const logoURL = 'Public/img/kedlogo.png';

//     const rows = window.rawData.map(d => ({
//         DateTime: new Date(d.datetime).toLocaleString('en-US', {
//             year: 'numeric',
//             month: '2-digit',
//             day: '2-digit',
//             hour: '2-digit',
//             minute: '2-digit',
//             hour12: true
//         }).replace(/(\d+)\/(\d+)\/(\d+),?/, '$3-$1-$2'),
//         Value: d.value.toFixed(3) + " kW"
//     }));

//     if (format === "pdf") {
//         try {
//             const { jsPDF } = window.jspdf;
//             const doc = new jsPDF();
//             const logo = new Image();
            
//             logo.onload = function() {
//                 // Add logo (top-left)
//                 doc.addImage(logo, 'PNG', 10, 10, 30, 10);
//                 generatePdfContent(doc);
//             };
            
//             logo.onerror = function() {
//                 generatePdfContent(doc);
//             };
//             logo.src = logoURL;
            
//             function generatePdfContent(doc) {
//                 // Report title (centered)
//                 doc.setFontSize(16);
//                 const titleY = logo.complete ? 30 : 20;
//                 doc.text(`Power Consumption Report`, 100, titleY, { align: "center" });
                
//                 // Slot path below title (left-aligned)
//                 doc.setFontSize(10);
//                 // doc.text(`Point: ${slotPath}`, 14, titleY + 18);
                
//                 // Generation timestamp (right-aligned)
//                 doc.text(`Generated: ${now.toLocaleString()}`, 200, 10, { align: "right" });

//                 // Create the table
//                 doc.autoTable({
//                 startY: titleY + 10, // Position below title and slot path
//                 head: [["Value (kW)", "Date & Time"]],
//                 body: rows.map(r => [r.Value, r.DateTime]),
//                 styles: {
//                   overflow: 'linebreak',
//                   cellPadding: 3,
//                   fontSize: 12,
//                   halign: 'center',   // Horizontally center text
//                   valign: 'middle'    // Vertically center text
//                 },
//                 columnStyles: {
//                   0: { cellWidth: 'auto' },
//                   1: { cellWidth: 'auto' }
//                 },
//                 margin: { top: titleY + 20 }
//               });


//                 doc.save(fileName);
//             }
//         } catch (error) {
//             console.error("PDF generation error:", error);
//             alert("Failed to generate PDF. Please try another format.");
//         }
//     } else {
//         try {
//             // For Excel/CSV - include slot path in each row
//             const exportData = window.rawData.map(d => ({
//                 "Point Path": slotPath,
//                 "Date & Time": new Date(d.datetime).toLocaleString('en-US', {
//                     year: 'numeric',
//                     month: '2-digit',
//                     day: '2-digit',
//                     hour: '2-digit',
//                     minute: '2-digit',
//                     second: '2-digit',
//                     hour12: true
//                 }),
//                 "Value (kW)": parseFloat(d.value.toFixed(3))
//             }));

//             const worksheet = XLSX.utils.json_to_sheet(exportData);
//             const workbook = XLSX.utils.book_new();
//             XLSX.utils.book_append_sheet(workbook, worksheet, "Power Data");
            
//             const wbout = XLSX.write(workbook, {
//                 bookType: format === "csv" ? "csv" : "xlsx",
//                 type: "array"
//             });
            
//             saveAs(new Blob([wbout], { type: "application/octet-stream" }), fileName);
//         } catch (error) {
//             console.error("Excel/CSV generation error:", error);
//             alert("Failed to generate Excel/CSV file.");
//         }
//     }
// };

  
//   // Format date as YYYY-MM-DD
//   function formatDate(date) {
//     const d = new Date(date);
//     return d.toISOString().split('T')[0];
//   }
  
//   // Initialize the application
//   function init() {
//     // Initialize chart
//     chart = initChart();
    
//     // Make fetchData available globally
//     fetchDataFunction = fetchData;
    
//     // Load default data
//     const end = new Date();
//     const start = new Date();
//     start.setMonth(start.getMonth() - 11);
//     start.setDate(30);
//     fetchData(formatDate(start), formatDate(end), true);
//   }
  
//   // Start the application
//   init();
// });


</script>
</body>
</html>